<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="介绍使用 elastic search">
<meta property="og:type" content="article">
<meta property="og:title" content="Elastic Search">
<meta property="og:url" content="http://yoursite.com/2020/06/29/elastic_search/index.html">
<meta property="og:site_name" content="Jijeng&#39;s blog">
<meta property="og:description" content="介绍使用 elastic search">
<meta property="article:published_time" content="2020-06-29T03:22:17.000Z">
<meta property="article:modified_time" content="2020-07-12T04:27:36.677Z">
<meta property="article:author" content="Jijeng Jia">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/29/elastic_search/"/>







<script>
	(function(){
		if(''){
			if (prompt('请输入文章密码','') !== ''){
				alert('密码错误！');
				history.back();
			}
		}
	})();
</script>

  <title>Elastic Search | Jijeng's blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jijeng's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/29/elastic_search/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jijeng Jia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jijeng's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Elastic Search</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-29T11:22:17+08:00">
                2020-06-29
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-07-12T12:27:36+08:00">
                2020-07-12
              </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/29/elastic_search/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/29/elastic_search/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>介绍使用 elastic search</p>
<a id="more"></a>


<h2 id="定义和特点"><a href="#定义和特点" class="headerlink" title="定义和特点"></a>定义和特点</h2><p>现代应用中全文本检索是高请求负载的应用。搜索功能也是比较困难完成的功能（许多大众网站都有subpar功能，但不是返回很慢就是返回结果不准确），大部分原因是因为底层数据库：许多标准关系型数据库只能提供基本字符串匹配功能，而对CONTAINS或者LIKE SQL查询只能提供有限支持。</p>
<p>一个为全文本检索优化的数据库，这也是本文采用Elasticsearch的原因。Elasticsearch是一个用Java开发的，开源的内存数据库，最开始是包含在Apache Lucene库中。</p>
<h3 id="概念和原理"><a href="#概念和原理" class="headerlink" title="概念和原理"></a>概念和原理</h3><p><a href="https://juejin.im/post/5d351143f265da1bd04f1e19#heading-12" target="_blank" rel="noopener">全文搜索引擎Elasticsearch，这篇文章给讲透了！</a></p>
<blockquote>
<p>主要是上述博客的学习笔记</p>
</blockquote>
<ol>
<li>数据</li>
</ol>
<p>数据分为结构化数据和非结构化数据。结构化数据主要通过关系数据库存储管理，所以通过关系数据库进行检索。非结构化数据不定长，无固定的格式。一般有两种方式进行检索： 顺序扫描法和全文检索。</p>
<p>全文检索是通过从非结构化数据中提取出结构信息然后再进行搜索，这种结构化信息称之为索引。工作量在于前期索引的创建，后期的搜索是快速高效的。</p>
<ol start="2">
<li><p>倒排索引：我们通过分词器将每个文档的内容域拆分成单独的词（我们称它为词条或 Term），创建一个包含所有不重复词条的排序列表，然后列出每个词条出现在哪个文档。</p>
</li>
<li><p>其中还需要有几个核心的术语需要理解：</p>
</li>
</ol>
<ul>
<li>词条(Term)：索引里面最小的存储和查询单元，对于英文来说是一个单词，对于中文来说一般指分词后的一个词</li>
<li>词典(Term Dictionary)：或字典，是词条Term的集合。搜索引擎的通常索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向“倒排列表”的指针。</li>
<li>倒排表(Post list)：一个文档通常由多个词组成，倒排表记录的是某个词在哪些文档里出现过以及出现的位置。</li>
<li>倒排文件(Inverted File)：所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件被称之为倒排文件，倒排文件是存储倒排索引的物理文件。</li>
</ul>
<ol start="4">
<li>集群（Cluster），分片（Shards）和副本（Replicas） 等方面的内容 可以等到真正上线之后再去考虑，先考虑其他功能方面的东西</li>
</ol>
<ol start="5">
<li>映射（Mapping）</li>
</ol>
<p>映射是用于定义ES 对索引中字段的存储类型，分词方式和是否存储等信息，就像数据库中的 schema，描述了文档可能具有的字段或属性，每个字段的数据类型。ES 对于字段类型可以不指定然后动态对字段类型猜测，称为动态映射（dynamic mapping）。传统数据库管理中，创建索引时候定义字段类型的映射称为静态映射或者显性映射（Explicit mapping）。当然 ES 也是支持使用静态映射的.</p>
<p>主要介绍两种数据类型: text 和keyword</p>
<p>text 用于索引全文值的字段，例如电子邮件正文或产品说明。这些字段是被分词的，它们通过分词器传递 ，以在被索引之前将字符串转换为单个术语的列表。</p>
<p>keyword 用于索引结构化内容的字段，例如电子邮件地址，主机名，状态代码，邮政编码或标签。</p>
<ol start="6">
<li>版本问题</li>
</ol>
<blockquote>
<p>在决定使用 Elasticsearch 的时候首先要考虑的是版本问题，Elasticsearch （排除 0.x 和 1.x）目前有如下常用的稳定的主版本：2.x，5.x，6.x，7.x（current）。你可能会发现没有 3.x 和 4.x，ES 从 2.4.6 直接跳到了 5.0.0。其实是为了ELK（ElasticSearch, logstash, kibana）技术栈的版本统一，免的给用户带来混乱。在 Elasticsearch 是 2.x （2.x 的最后一版 2.4.6 的发布时间是 July 25, 2017） 的情况下，kibana 已经是 4.x（Kibana 4.6.5 的发布时间是 July 25, 2017），那么在 kibana 的下一主版本肯定是 5.x 了，所以 Elasticsearch 直接将自己的主版本发布为 5.0.0 了。统一之后，我们选版本就不会犹豫困惑了，我们选定 elasticsearch 的版本后再选择相同版本的 kibana 就行了，不用担忧版本不兼容的问题。</p>
</blockquote>
<ol start="7">
<li>检查集群状态</li>
</ol>
<p>在 kibana 中使用以下命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/health</span><br></pre></td></tr></table></figure>

<p>集群状态通过 绿，黄，红 来标识</p>
<ul>
<li>绿色：集群健康完好，一切功能齐全正常，所有分片和副本都可以正常工作。</li>
<li>黄色：预警状态，所有主分片功能正常，但至少有一个副本是不能正常工作的。此时集群是可以正常工作的，但是高可用性在某种程度上会受影响。</li>
<li>红色：集群不可正常使用。某个或某些分片及其副本异常不可用，这时集群的查询操作还能执行，但是返回的结果会不准确。对于分配到这个分片的写入请求将会报错，最终会导致数据的丢失。</li>
</ul>
<p>8.机制原理</p>
<p>写索引这部分暂时没有看 （这部分很重要）</p>
<p>存储原理</p>
<blockquote>
<p>索引文档以段的形式存储在磁盘上，何为段？索引文件被拆分为多个子文件，则每个子文件叫作段， 每一个段本身都是一个倒排索引，并且段具有不变性，一旦索引的数据被写入硬盘，就不可再修改。在底层采用了分段的存储模式，使它在读写时几乎完全避免了锁的出现，大大提升了读写性能。<br>段被写入到磁盘后会生成一个提交点，提交点是一个用来记录所有提交后段信息的文件。一个段一旦拥有了提交点，就说明这个段只有读的权限，失去了写的权限。相反，当段在内存中时，就只有写的权限，而不具备读数据的权限，意味着不能被检索。</p>
</blockquote>
<p>索引文件分段存储并且不可修改，那么新增、更新和删除如何处理呢？</p>
<ul>
<li>新增，新增很好处理，由于数据是新的，所以只需要对当前文档新增一个段就可以了。</li>
<li>删除，由于不可修改，所以对于删除操作，不会把文档从旧的段中移除而是通过新增一个.del文件，文件中会列出这些被删除文档的段信息。这个被标记删除的文档仍然可以被查询匹配到， 但它会在最终结果被返回前从结果集中移除。</li>
<li>更新，不能修改旧的段来进行反映文档的更新，其实更新相当于是删除和新增这两个动作组成。会将旧的文档在.del文件中标记删除，然后文档的新版本被索引到一个新的段中。可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就会被移除。</li>
</ul>
<p>延迟写策略</p>
<p>为了提升写的性能，ES并没有每新增一条数据就增加一个段到磁盘上，而是采用延迟写的策略。<br>每当有新增的数据时，就将其先写入到内存中，在内存和磁盘之间是文件系统缓存，当达到默认的时间（1秒钟）或者内存的数据达到一定量时，会触发一次刷新（Refresh），将内存中的数据生成到一个新的段上并缓存到文件缓存系统 上，稍后再被刷新到磁盘中并生成提交点。</p>
<blockquote>
<p>当post 数据的时候，可以手动触发 refresh，这样相当于将内存中的数据存放到了磁盘中</p>
</blockquote>
<p>在 Elasticsearch 中，写入和打开一个新段的轻量的过程叫做 refresh （即内存刷新到文件缓存系统）。 默认情况下每个分片会每秒自动刷新一次。这就是为什么我们说 Elasticsearch 是近实时搜索，因为文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。我们也可以手动触发 refresh，<code>POST /_refresh</code> 刷新所有索引，<code>POST /nba/_refresh</code> 刷新指定的索引。</p>
<p>段合并</p>
<p>Elasticsearch通过在后台定期进行段合并来解决这个问题。小的段被合并到大的段，然后这些大的段再被合并到更大的段。段合并的时候会将那些旧的已删除文档从文件系统中清除。被删除的文档不会被拷贝到新的大段中。合并的过程中不会中断索引和搜索。</p>
<h3 id="elastic-search-特点"><a href="#elastic-search-特点" class="headerlink" title="elastic search 特点"></a>elastic search 特点</h3><p>分布式文件存储， 实时分析；实现搜索引擎的功能。</p>
<p>elastic search 中的名词 和 mysql 中的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">索引 - &gt; 数据库</span><br><span class="line"></span><br><span class="line">类型 -&gt; 数据表</span><br><span class="line"></span><br><span class="line">文档 -&gt; 一条条数据</span><br><span class="line"></span><br><span class="line">elasticSearch 概念-倒排索引</span><br></pre></td></tr></table></figure>


<p>inverted index (倒排索引)</p>
<p>“索引” 是数据库中的一种数据结构，它能够以超快的速度进行数据查询和检索操作。数据库通过存储与表中行相关联的字段来生成索引。在一种可搜索的数据结构（一般是 B 树）中排序索引，在优化过的查询中，数据库能够达到接近线性的时间（比如，“使用 ID=5 查找行”）。</p>
<h3 id="elasticsearch-的不足"><a href="#elasticsearch-的不足" class="headerlink" title="elasticsearch 的不足"></a>elasticsearch 的不足</h3><ol>
<li>资源消耗</li>
</ol>
<p>Elasticsearch是计算资源消耗的应用。官方建议至少运行在64G以上内存的设备上，不建议少于8GB内存。Elasticsearch是一个内存数据库，因此查询速度会很快，但是也会消耗大量内存。生产中，强烈推荐运行Elasticsearch集群提供高可用性、自动分片和数据冗余功能。</p>
<p>（服务器机器上的内存： 125G）</p>
<ol start="2">
<li>数据库之间的同步</li>
</ol>
<p>对许多应用，将数据存放在Elasticsearch中并不是理想的选择。</p>
<h2 id="学习笔记"><a href="#学习笔记" class="headerlink" title="学习笔记"></a>学习笔记</h2><ol>
<li>安装docker</li>
</ol>
<p>单节点模式discovery.type=single-node</p>
<p>跨域配置，这样外部请求才能服务ES</p>
<p>在elasticsearch.yml中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: “*”</span><br></pre></td></tr></table></figure>

<ul>
<li>9200端口：ES节点和外部通讯使用</li>
<li>9300端口：ES集群内，节点之间通讯使用</li>
</ul>
<p>1.1 安装docker-compose</p>
<p>（这个在这个步骤是可选的，因为没有涉及到许多镜像文件）</p>
<blockquote>
<p>docker-compose是编排容器的。例如，你有一个php镜像，一个mysql镜像，一个nginx镜像。如果没有docker-compose，那么每次启动的时候，你需要敲各个容器的启动参数，环境变量，容器命名，指定不同容器的链接参数等等一系列的操作，相当繁琐。而用了docker-composer之后，你就可以把这些命令一次性写在docker-composer.yml文件中，以后每次启动这一整个环境（含3个容器）的时候，你只要敲一个docker-composer up命令就ok了。</p>
</blockquote>
<ol start="2">
<li>docker 安装 elastic search</li>
</ol>
<p>2.1 docker 安装 ElasticSearch-head，这个是安装 es 的管理工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Docker安装ElasticSearch-head</span><br><span class="line">安装：docker pull mobz&#x2F;elasticsearch-head:5</span><br><span class="line">启动：docker run -d -p 9100:9100 docker.io&#x2F;mobz&#x2F;elasticsearch-head:5</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>管理数据</p>
</li>
<li><p>分词检索（对应文章 和 image id）</p>
</li>
<li><p>http 传递到前端展示</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看结点信息</span><br><span class="line">curl localhost:9200&#x2F;_cat&#x2F;nodes</span><br><span class="line"></span><br><span class="line">curl localhost:9200&#x2F;_cat&#x2F;health</span><br><span class="line">curl http:&#x2F;&#x2F;192.168.1.34:9200&#x2F;_cat&#x2F;health</span><br></pre></td></tr></table></figure>

<ol>
<li>_cat</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_cat&#x2F;nodes ; 查看所有节点</span><br><span class="line">GET &#x2F;_cat&#x2F;health ; 查看es 健康状况</span><br><span class="line">GET &#x2F;_cat&#x2F;master ; 查案主节点</span><br><span class="line">GET &#x2F;_cat&#x2F;indices; 查看所有的索引 -&gt; show datasets (数据库操作) ; 查看数据库信息</span><br></pre></td></tr></table></figure>
<p>从docker hub 中检索 image 并且安装</p>
<ol start="2">
<li>索引一个文件（保存一个数据）</li>
</ol>
<p>（索引 对应 mysql数据库； 类型对应的mysql 的表）<br>保存一个数据，保存哪个索引的哪个类型下，指定用哪个唯一的标识</p>
<p>PUT 用来保存请求，需要给 body 信息（必须指定id）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">put localhost:9200&#x2F;customer&#x2F;external&#x2F;1</span><br><span class="line"></span><br><span class="line">post 用来保存请求（新增保存二合一）</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查询文档</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get localhost:</span><br><span class="line"></span><br><span class="line">curl  localhost:9200&#x2F;img_text&#x2F;column3&#x2F;_search</span><br></pre></td></tr></table></figure>



<p>docker 安装</p>
<p>elastic search（mysql）<br>kibana 可视化检索数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker images # 下载的镜像</span><br><span class="line">docker ps # 正在运行的镜像</span><br><span class="line"></span><br><span class="line"># 这个命令好好理解，经常是使用的</span><br><span class="line">9300 是在分布下的结点通信使用； 9200 是http 请求。</span><br><span class="line">docer run --name elasticsearch -p 9200:9200 -p 9300:9300 \ </span><br><span class="line">-e &quot;discovery.type&#x3D;single-node&quot; \ </span><br><span class="line">-e ES_JAVA_OPTS&#x3D;&quot;&quot; 内存方面方面 \ 上线之后 32G 左右</span><br><span class="line">-v &#x2F;mydata&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml \</span><br><span class="line">-v &#x2F;mydata&#x2F;elasticsearch&#x2F;data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data \</span><br><span class="line">-v &#x2F;mydata&#x2F;elasticsearch&#x2F;plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins \ # 挂载操作</span><br><span class="line">-d elasticsearch:7.4.2</span><br></pre></td></tr></table></figure>

<p>其中的 <code>-d</code> 是后台运行，deployment 的意思； <code>-e</code> 是设置环境变量的意思； <code>-p</code> 是把容器的 9100 端口暴露出来，方便 nginx 转发</p>
<p>kibana</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 通过访问 5601 的端口，然后 kibana 转到了 elastic search中的 9200</span><br><span class="line">docker run -name kibana -e ELASTICSEARCH_HOSTS&#x3D;http:&#x2F;&#x2F;192.168.56.10:9200 -p 5601:5601 -d kibana:7.4.2</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>索引一个文档（保存）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">put customer&#x2F;external&#x2F;1;  在 customer 索引下的 external 类型中保存 1号数据为</span><br><span class="line"></span><br><span class="line">put customer&#x2F;external&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;John Doe&quot;</span><br><span class="line"></span><br><span class="line">put 和post 都是可以的。</span><br><span class="line"></span><br><span class="line">post 新增和修改。新增：不带 id，带id 但是之前没有数据；修改：带id，并且有数据。</span><br><span class="line"></span><br><span class="line">put 可以新增可以修改。put 必须指定id；由于 put 需要指定 id，我们一般都用来做修改操作，不指定id 会报错。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查询文档</li>
</ol>
<p>GET customer/external/1</p>
<p>要求只能是一个在修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 乐观锁，并发控制</span><br><span class="line">&quot;_seq_no&quot;: 1,</span><br><span class="line">&quot;_primary_term&quot; :1,</span><br></pre></td></tr></table></figure>


<ol start="4">
<li>更新文档</li>
</ol>
<p>下面的方式 也是可以增加属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">post customr&#x2F;external&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line"># 如果是_update ，那么一定需要带上 doc</span><br><span class="line"># 会对比原来的数据， 版本号.. 都是不会变</span><br><span class="line">&quot;doc&quot;:&#123;</span><br><span class="line">&quot;name&quot;:&quot;john Doew&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 或者 </span><br><span class="line">post customer&#x2F;external&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">#不会对比原来数据，直接更新数据</span><br><span class="line">&quot;name&quot;: &quot;John Doe2&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 或者</span><br><span class="line"># 不会对比原来数据，直接更新数据</span><br><span class="line">PUT customer&#x2F;external&#x2F;1</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>删除文档和索引</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE customer</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>bulk 批量api</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST customer&#x2F;external&#x2F;_bulk</span><br><span class="line"></span><br><span class="line">&#123;&quot;index&quot;: &#123;&quot;_id&quot; :&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;: &quot;John Doe&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;: &#123;&quot;_id&quot; :&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;: &quot;john&quot;&#125;</span><br></pre></td></tr></table></figure>


<p>在 kibana 中的dev tool 来发送测试请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;customer&#x2F;external&#x2F;_bulk</span><br><span class="line">&#123;&quot;index&quot;: &#123;&quot;_Id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;: &quot;John Doe&quot;&#125;</span><br><span class="line"></span><br><span class="line">&quot;create&quot;  # 创建</span><br><span class="line">&quot;delete&quot; # 删除操作</span><br><span class="line">&quot;index&quot; # 保存操作</span><br><span class="line">&quot;update&quot; # 更新操作</span><br><span class="line">&#96;&#96;&#96;</span><br></pre></td></tr></table></figure>
<p>POST /_bulk # 批量执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">四、</span><br><span class="line"></span><br><span class="line">可以设置自动启动的</span><br></pre></td></tr></table></figure>
<p>sudo docker update id(or name) –restart =always</p>
<p>ES 中检索的两种方式</p>
<ol>
<li>搜索条件放在 url 中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 升序排序</span><br><span class="line">GET bank&#x2F;_search?q&#x3D;*&amp;sort&#x3D;account_number:asc</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>query DSL (复杂 query)</li>
</ol>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html</a></p>
<p>elastic search 作为检索功能的讲解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 搜索条件放在结构体中</span><br><span class="line"># 先升序 然后再降序</span><br><span class="line"># match_all 查询所有</span><br><span class="line"># _source 返回部分字段</span><br><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;&quot;match_all&quot; : &#123;&#125;&#125;,</span><br><span class="line">&quot;sort&quot; : [ &#123;&quot;account_number&quot; : &quot;asc&quot;&#125;, &#123;&quot;balance&quot;: &quot;desc&quot;&#125;] </span><br><span class="line">&quot;from&quot;: 10,</span><br><span class="line">&quot;_source&quot;: [&quot;balance&quot;, &quot;firstname&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>match 匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#  match 匹配非字符串，那么就是精确查询。</span><br><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; :&#123;</span><br><span class="line">&quot;match&quot; :&#123;&quot;balance&quot; : 20&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 字符串的全文检索 （只要包含这个信息的）</span><br><span class="line"># 倒排索引</span><br><span class="line"># 其中有 _score 关键字，表示匹配的程度，按照_score 进行</span><br><span class="line"># 对于 query 进行分词匹配</span><br><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; :&#123;</span><br><span class="line">&quot;match&quot; :&#123;&quot;address&quot; : &quot;Kings&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># match_phase 短词分词（不进行分词，当做完整的短语）</span><br><span class="line"></span><br><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">&quot;match_phrase&quot; :</span><br><span class="line">&#123;</span><br><span class="line">&quot;address&quot;: &quot;mill land&quot;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 多字段匹配，多个字段只要有一个能匹配上 query 就行， 对query 进行分词的</span><br><span class="line"></span><br><span class="line">GET bank&#x2F;_search&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">&quot;multi_mach&quot; :&#123;</span><br><span class="line">&quot;query&quot;: &quot;mill&quot;,</span><br><span class="line">&quot;fields&quot;: [&quot;address&quot;, &quot;name&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># bool 查询（复合查询）</span><br><span class="line"># 三个关键字 must， must_not, should 可选的；满足了 _score 会更高，结果比较排前</span><br><span class="line"># must, should can contribute to how documents are scored. </span><br><span class="line"># must_not is treated as a filter, but does not contribute to how documents are scored</span><br><span class="line"> </span><br><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; : &#123;</span><br><span class="line">&quot;bool&quot;:&#123;</span><br><span class="line">&quot;must&quot;: [&#123;</span><br><span class="line">&#125;]</span><br><span class="line">&quot;must_not&quot; :[&#123;&#125;]</span><br><span class="line">&quot;should&quot; :[&#123;&#125;]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># term </span><br><span class="line"># 使用条件, avoid using the term query for text fields. To search text field values, use the match query instead. </span><br><span class="line"># 当检索非字符串 使用term 关键词； 当检索字符串时候，使用 match 关键字</span><br><span class="line"></span><br><span class="line"># 当 ES 在存储 text 字段的时候， 存在 analysis 分词的问题，那么这个时候使用 term 进行 exact match 那么就是非常困难的。</span><br><span class="line"></span><br><span class="line">GET  bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; : &#123;</span><br><span class="line">&quot;term&quot; : &#123;&quot;age&quot; : &quot;28&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># keyword 和 match_phrase 的区别： 前者是 特别exact，后者是整体包含就ok</span><br><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; : &#123;</span><br><span class="line">&quot;match&quot; :&#123;</span><br><span class="line">&quot;address.keyworrd&quot; :&quot;789 MAdison&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="9">
<li>aggregation （执行聚合）</li>
</ol>
<p>聚合提供了从数据中分组和提取数据的能力。大致等原因 SQL GROUP BY 和 SQL 聚合函数。</p>
<p>聚合是可以嵌套的。</p>
<p>搜索address 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; :&#123;</span><br><span class="line">&quot;match&quot;: &#123;</span><br><span class="line">&quot;address&quot;: &quot;mill&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"># 基于上一步进行聚合</span><br><span class="line">&quot;aggs&quot;: &#123;</span><br><span class="line">&quot;ageAvg&quot; :&#123;</span><br><span class="line">&quot;avg&quot; : &#123;</span><br><span class="line">&quot;field&quot; : &quot;age&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;balanceAvg&quot;: &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">size &#x3D;0 # 不看查询结构，只是查看 agg 的结果</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里是嵌套的聚合操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; :&#123;</span><br><span class="line">&quot;match_all&quot; : &#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;aggs&quot; : &#123;</span><br><span class="line">&quot;aggAgg&quot; : &#123;</span><br><span class="line">&quot;terms&quot; : &#123;</span><br><span class="line">&quot;field&quot; : &quot;age&quot;,</span><br><span class="line">&quot;size&quot; : 100</span><br><span class="line">&#125;,</span><br><span class="line"># 这个是在上一步的基础上进行聚合</span><br><span class="line">&quot;aggs&quot;: &#123;</span><br><span class="line">&quot;ageAvg&quot;: &#123;</span><br><span class="line">&quot;avg&quot; : &#123;&quot;field&quot; : &quot;balance&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>mapping</li>
</ol>
<p>ES 7 去掉了 type 就是为了提高 ES 处理数据的效率。 ES 是基于 Lucene 开发的搜索引擎，在ES 中不同type 下名称相同的filed 最终在 Lucene 中处理方式是一样的。 所以直接去掉了中间的概念 type。ES 8 就没有type 字段了。第一次导入数据，我们不用刻意指定 type，因为 ES 已经帮我们猜测得到了 type。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_mapping</span><br><span class="line"># 这样就得到了字典映射类型</span><br><span class="line">数字是long 类型；文本是 text 类型，默认有 keyword 属性。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 添加一个新的字段映射</span><br><span class="line">PUT &#x2F;my_index&#x2F;_mapping</span><br><span class="line">&#123;</span><br><span class="line">&quot;properties&quot; :&#123;</span><br><span class="line">&quot;employee-id&quot; : &#123;</span><br><span class="line">&quot;type&quot; :&quot;keyword&quot;,</span><br><span class="line">&quot;index&quot; : false # 这个参数很重要，表明是否可以被检索到，如果是false，那么就不参与检索</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 修改一个新的字段映射 （这样是不成立）</span><br><span class="line"># 更新index 的操作：先创建出 新的 正确的映射，然后使用如下的方式进行数据迁移</span><br><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">&quot;source&quot; : &#123;&quot;index&quot; : &quot;twitter&quot;&#125;</span><br><span class="line">&#125; ,</span><br><span class="line">&quot;dest&quot; : &#123;&quot;index&quot; : &quot;new_twitter&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 总结， 不用type，如果需要新的字段映射，那么首先先创建新的正确映射，然后再进行数据迁移</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 全文检索 elastic search 分词</span><br><span class="line"></span><br><span class="line"># 标准的分词,  ES 都是针对英文的分词，如果是中文 （那么需要找到对应的 ik 分词器）</span><br><span class="line"></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">&quot;analyzer&quot; : &quot;standard&quot;,</span><br><span class="line">&quot;text&quot; : &quot;The 2 Quick Brown-foxes jumped over the lazy dog&#39;s hone.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">&quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">&quot;text&quot; :&quot;我是中国人&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 自定义扩展词库</span><br><span class="line"># 把自定义的词库放到 nginx 服务器上，然后访问服务器就可以下载到本地，这样是可以随时更新词库的</span><br><span class="line"># 在docker 中使用nginx</span><br><span class="line"></span><br><span class="line">docker run -p 80:80 -name nginx -d nginx:1.10</span><br><span class="line"></span><br><span class="line">先使用 docker image 查看本地下载的镜像，然后 docker 可以run，如果第一次 run，那么是会先下载然后再run</span><br><span class="line"></span><br><span class="line">docker container cp nginx:&#x2F;etc&#x2F;nginx .</span><br><span class="line">docker stop nginx</span><br><span class="line">docker rm nginx</span><br><span class="line">mv nginx conf</span><br><span class="line">mkdir nginx </span><br><span class="line">mv conf nginx</span><br><span class="line"></span><br><span class="line"># 这个是端口映射，外部的80 端口映射到nginx 的80 端口</span><br><span class="line">docker run -p 80:80 --name nginx \</span><br><span class="line">-v &#x2F;mydata&#x2F;nginx&#x2F;html:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html \</span><br><span class="line">-v &#x2F;mydata&#x2F;nginx&#x2F;logs:&#x2F;var&#x2F;log&#x2F;nginx \</span><br><span class="line">-v &#x2F;mydata&#x2F;nginx&#x2F;conf:&#x2F;etc&#x2F;nginx \</span><br><span class="line">-d nginx:1.10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">写一个 html 也是非常的简单，只要放到index 文件夹中 就ok index.html</span><br><span class="line">nginx 是默认加载 html 中的资源</span><br><span class="line">mkdir es</span><br><span class="line">vi fenci.txt</span><br></pre></td></tr></table></figure>












<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker ps # 表示正在运行的镜像</span><br><span class="line">docker ps -a # 所有的镜像（包括没有运行的） </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker # 可以重新挂载到不同的目录中，然后走到对应的目录中</span><br><span class="line"></span><br><span class="line">docker exec -it 84ca &#x2F;bin&#x2F;bash # 使用交互的方式 进入到了docker 84ca的镜像中 ，然后pwd 看看这里的目录</span><br><span class="line">使用 exit 退出容器中</span><br><span class="line"></span><br><span class="line">docker 的安装，都做好外部的挂载就 ok，这个步骤很重要，本地保存的观念。挂载到本地的好处，就是即使 docker down掉了，但是本地的数据和 plugin 还是可以保存下来，这样的话可以重新启动一下。</span><br><span class="line"></span><br><span class="line"># 这个是重启命令</span><br><span class="line">docker restart elasticsearch </span><br><span class="line"></span><br><span class="line">docker update elasticsearch --restart&#x3D;always</span><br></pre></td></tr></table></figure>


<h3 id="ES-中index-的理解"><a href="#ES-中index-的理解" class="headerlink" title="ES 中index 的理解"></a>ES 中index 的理解</h3><p><a href="http://www.elasticsearchtutorial.com/basic-elasticsearch-concepts.html" target="_blank" rel="noopener">ElasticsearchTutorial.com</a></p>
<blockquote>
<p>Elasticsearch is able to achieve fast search responses because, instead of searching the text directly, it searches an index instead. This is like retrieving pages in a book related to a keyword by scanning the index at the back of a book, as opposed to searching every word of every page of the book. This type of index is called an inverted index, because it inverts a page-centric data structure (page-&gt;words) to a keyword-centric data structure (word-&gt;pages).</p>
</blockquote>
<p><a href="https://medium.com/elasticsearch/what-happens-when-a-document-is-indexed-in-elasticsearch-16b7ae3415bc" target="_blank" rel="noopener">What happens when a document is indexed in Elasticsearch?</a></p>
<blockquote>
<p>要有意识说将数据locate 到某个固定的地方，数据是很重要的.</p>
</blockquote>
<p>在这里设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;elasticsearch&#x2F;elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p>或者使用 <code>path.data</code> 进行传参。</p>
<p><a href="https://logz.io/blog/10-elasticsearch-concepts/" target="_blank" rel="noopener">10 Elasticsearch Concepts You Need to Learn</a></p>
<ol>
<li>Fields</li>
</ol>
<blockquote>
<p>Each field has a defined datatype and contains a single piece of data. Those datatypes include the core datatypes (strings, numbers, dates, booleans), complex datatypes (object and nested), geo datatypes (get_point and geo_shape), and specialized datatypes (token count, join, rank feature, dense vector, flattened, etc.)<br>es 中的field 类似数据库中的数据类型</p>
</blockquote>
<ol start="2">
<li>Multi-fields</li>
</ol>
<blockquote>
<p>These fields can (and should) be indexed in more than one way to produce more search results. This option is available easily through the “multi-fields” option, which as you might have guessed allow for fields to be indexed in multiple ways. For example, something might be indexed either as free text or a specific keyword.<br>说实话，没有很明白 multi-fields 是怎么回事？ 如何使用起来的</p>
</blockquote>
<ol start="3">
<li>Documents</li>
</ol>
<p>Documents also contain reserved fields that constitute the document metadata such as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_index – the index where the document resides</span><br><span class="line">_type – the type that the document represents</span><br><span class="line">_id – the unique identifier for the document</span><br></pre></td></tr></table></figure>



<p><a href="https://medium.com/elasticsearch/what-happens-when-a-document-is-indexed-in-elasticsearch-16b7ae3415bc" target="_blank" rel="noopener">What happens when a document is indexed in Elasticsearch?</a></p>
<img src = 'https://ftp.bmp.ovh/imgs/2020/07/f97f33d823247eb2.png'  height="80%" width="60%"/>

<p>从上图可以知道在index 过程中使用了 analyzer 对数据进行了预处理。</p>
<p><a href="https://www.elastic.co/cn/blog/what-is-an-elasticsearch-index" target="_blank" rel="noopener">What is an Elasticsearch Index?</a></p>
<p>The easiest and most familiar layout clones what you would expect from a relational database. You can (very roughly) think of an index like a database.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL &#x3D;&gt; Databases &#x3D;&gt; Tables &#x3D;&gt; Columns&#x2F;Rows</span><br><span class="line">Elasticsearch &#x3D;&gt; Indices &#x3D;&gt; Types &#x3D;&gt; Documents with Properties</span><br></pre></td></tr></table></figure>


<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-index.html#getting-started-index" target="_blank" rel="noopener">Index some documents</a></p>
<blockquote>
<p>index 的操作，是可以 bulk 操作，这样可以节省时间。</p>
</blockquote>
<p><strong>Index索引的命令行操作</strong></p>
<p>index 相当于数据库的表，是 es 数据管理的顶层单位。这里主要是从命令行的角度去分析</p>
<p>（这个实际上是可以通过查看api 获得的，在 guide 文件中）</p>
<ol>
<li>创建索引</li>
</ol>
<p>创建索引 article</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;article&#39;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>删除索引</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE &#39;localhost:9200&#x2F;article&#39;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看所有索引</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &quot;localhost:9200&#x2F;_cat&#x2F;indices?v&quot;</span><br></pre></td></tr></table></figure>



<p><strong>Document文档</strong></p>
<p>Index 里面单条的记录称为 Document（文档）。许多条 Document 构成了一个 Index。</p>
<p><strong>Query DSL</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">term 精确词查询</span><br><span class="line">match 匹配查询</span><br><span class="line">multi_match 多条件查询</span><br></pre></td></tr></table></figure>

<p>query 需要计算相关性, filter 不需要计算相关性，且 es 会缓存频繁查询的 filter 结果，所以 filter 会更快。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><h3 id="教程方面"><a href="#教程方面" class="headerlink" title="教程方面"></a>教程方面</h3><p>优秀的资料</p>
<ol>
<li><a href="https://www.youtube.com/watch?v=q_DUpJQjEoQ" target="_blank" rel="noopener">全文检索 ElasticSearch 简介</a></li>
</ol>
<blockquote>
<p>很好的视频教程，特点是很全面的讲解了 elastic search和 kibana 的使用</p>
</blockquote>
<ol start="2">
<li><a href="[Elasticsearch](http://masikkk.com/article/Elasticsearch/#)">Elasticsearch</a></li>
</ol>
<blockquote>
<p>很好的中文博客文档，其中介绍 elastic search 从部署到使用，不仅给出了命令，并且很多情况下都给出了相应的解释。有时间的情况下，建议都过一下。</p>
</blockquote>
<ol start="3">
<li><a href="https://juejin.im/post/5d351143f265da1bd04f1e19" target="_blank" rel="noopener">全文搜索引擎Elasticsearch，这篇文章给讲透了！</a></li>
</ol>
<blockquote>
<p>很好的博客文档，介绍了 elastic search中的一些概念，有时间建议都过一下。</p>
</blockquote>
<ol start="4">
<li><a href="https://zhuanlan.zhihu.com/p/34935579" target="_blank" rel="noopener">Docker 三剑客之 Docker Compose</a></li>
</ol>
<blockquote>
<p>关于 docker compose 中文教程，重点看</p>
</blockquote>
<ol start="5">
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.2/analysis-custom-analyzer.html" target="_blank" rel="noopener">Custom Analyzer</a></li>
</ol>
<p>官方的文档： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.2/docker.html#docker" target="_blank" rel="noopener">Install Elasticsearch with Docker</a></p>
<blockquote>
<p>这个在之后是必然要做的， 个性化字典； 并且这个官方的文档是一定要多翻阅</p>
</blockquote>
<p>5.1 <a href="https://qbox.io/blog/elasticsearch-english-analyzer-customize" target="_blank" rel="noopener">The Elasticsearch English Analyzer: Diving Deep and Customizing</a></p>
<blockquote>
<p>可以作为 个性化词典的补充内容参考</p>
</blockquote>
<ol start="6">
<li><a href="https://segmentfault.com/a/1190000020140461" target="_blank" rel="noopener">Docker下安装ElasticSearch和Kibana</a></li>
</ol>
<blockquote>
<p>是按照这个教程搭建的本机的一个 elastic search 和kibana</p>
</blockquote>
<p><a href="https://medium.com/faun/building-a-real-time-elastic-search-engine-using-python-32e05bcb9140" target="_blank" rel="noopener">https://medium.com/faun/building-a-real-time-elastic-search-engine-using-python-32e05bcb9140</a></p>
<p>一般资料</p>
<ol>
<li><a href="https://chenshinan.github.io/2019/07/07/%E5%9F%BA%E4%BA%8EElasticSearch%E7%9A%84%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2/" target="_blank" rel="noopener">基于ElasticSearch的全文搜索</a></li>
</ol>
<blockquote>
<p>博客学习资料，主要是介绍了  elastic search的一些概念，没有代码</p>
</blockquote>
<ol start="2">
<li><a href="https://www.cnblogs.com/jianxuanbing/p/9410800.html" target="_blank" rel="noopener">Docker 简单部署 ElasticSearch</a></li>
</ol>
<blockquote>
<p>入门级别的安装部署教程，无代码</p>
</blockquote>
<ol start="3">
<li><a href="http://www.ruanyifeng.com/blog/2017/08/elasticsearch.html?20180719152505#comment-last" target="_blank" rel="noopener">阮一峰, 全文搜索引擎 Elasticsearch 入门教程 </a></li>
</ol>
<blockquote>
<p>质量是有保证的，是一些入门几倍的教程。</p>
</blockquote>
<p>其他</p>
<ol>
<li><a href="https://www.awaimai.com/2587.html" target="_blank" rel="noopener">docker-compose up解决错误ERROR</a><blockquote>
<p>罗列了很多 docker-compose error的原因</p>
</blockquote>
</li>
</ol>
<h3 id="code方面"><a href="#code方面" class="headerlink" title="code方面"></a>code方面</h3><ol>
<li><a href="https://github.com/zouzias/docker-flask-elasticsearch-example" target="_blank" rel="noopener">docker-flask-elasticsearch-example</a></li>
</ol>
<p>[已经下载] 这个run 不起来，是写的版本有问题</p>
<ol start="2">
<li><a href="https://github.com/ashokc/Serving-Flask-on-Docker" target="_blank" rel="noopener">A Serving Flask on Docker</a></li>
</ol>
<p>对应的教程：<a href="http://xplordat.com/2020/03/03/a-serving-flask-on-docker/" target="_blank" rel="noopener">A Serving Flask on Docker</a></p>
<blockquote>
<p> 这个看起来是比较好的项目，可以尝试一下，并且是比较promising 的项目</p>
</blockquote>
<p>按照教程已经全部走完，但就是最后一部走不通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8080&#x2F;quotes&#x2F;byId?id&#x3D;86789</span><br></pre></td></tr></table></figure>


<p>2.1 <a href="https://github.com/ashokc/A-Flask-full-of-WSGI" target="_blank" rel="noopener">A-Flask-full-of-WSGI</a></p>
<p>对应的教程: <a href="http://xplordat.com/2020/02/16/a-flask-full-of-whiskey-wsgi/" target="_blank" rel="noopener">A Flask Full of Whiskey (WSGI)</a></p>
<blockquote>
<p>这个是上述作者之前的项目</p>
</blockquote>
<p>这个先不进行尝试，因为不是docker镜像，需要修改的是系统的 nginx，总体比较麻烦一些。</p>
<ol start="3">
<li><a href="https://github.com/dineshsonachalam/Building-a-search-engine-using-Elasticsearch" target="_blank" rel="noopener">Building-a-search-engine-using-Elasticsearch</a></li>
</ol>
<p>已经 在env_guest 中run 起来了</p>
<blockquote>
<p>这个已经run 起来了，好好看看代码，学习以下；改造成想要的样子</p>
</blockquote>
<p>对应的教程：<br><a href="https://medium.com/faun/building-a-real-time-elastic-search-engine-using-python-32e05bcb9140" target="_blank" rel="noopener">Building a real-time elastic search engine using Python</a></p>
<p>”对应的教程“的学习笔记</p>
<blockquote>
<p>We will store the indexed data in the Elasticsearch container to ES_DATA folder in our project folder. The basic syntax for mounting volumes is /host/path:/container/path<br>其中的 ES_DATA 和indexed data，这个仍然是对不上号的。现在不知道之前的 elastic search 的data 保存在哪个目录下，貌似自己没有挂载到本地的目录</p>
</blockquote>
<h2 id="数据整合"><a href="#数据整合" class="headerlink" title="数据整合"></a>数据整合</h2><p>Elasticsearch 的导入和导出工具</p>
<ol>
<li>官方有自带的导入导出工具</li>
</ol>
<ol start="2">
<li>第三方插件</li>
</ol>
<ul>
<li><a href="https://pypi.org/project/es2csv/" target="_blank" rel="noopener">es2csv</a></li>
</ul>
<p>简介：用Python编写的命令行实用程序，用于以Lucene查询语法或查询DSL语法查询Elasticsearch，并将结果作为文档导出到CSV文件中。<br>es2csv 可以查询多个索引中的批量文档，并且只获取选定的字段，这可以缩短查询执行时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1es2csv -u 192.168.1.1:9200 -q &#39;&#123;&quot;_source&quot;:&#123;&quot;excludes&quot;:[&quot;*gxn&quot;,,&quot;*kex&quot;,&quot;vperxs&quot;,&quot;lpix&quot;]&#125;,&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;this_topic&quot;:&#123;&quot;value&quot;:41&#125;&#125;&#125;&#125;&#39; -r -i sogou_topic -o ~&#x2F;export.csv</span><br></pre></td></tr></table></figure>

<p>Elasticsearch导出CSV首选方案。</p>
<ul>
<li><a href="https://github.com/taskrabbit/elasticsearch-dump" target="_blank" rel="noopener">elasticsearch-dump</a></li>
</ul>
<p>Elasticsearch导出json首选方案。</p>
<p>先使用一个可视化界面导入数据吧</p>
<p><a href="http://192.168.1.34:5601/app/ml#/filedatavisualizer?_g=()" target="_blank" rel="noopener">http://192.168.1.34:5601/app/ml#/filedatavisualizer?_g=()</a></p>
<p>pin_text</p>
<p>id:<br>ObjectId(“5ef0e5f77de7450ba43f5017”)<br>original_pics:<br><a href="https://i.pinimg.com/originals/cf/3f/26/cf3f268fc488f2a9798c0a8d03370a94.jpg" target="_blank" rel="noopener">https://i.pinimg.com/originals/cf/3f/26/cf3f268fc488f2a9798c0a8d03370a94.jpg</a><br>url:<br>“<a href="https://www.pinterest.com/pin/795518721656674891/&quot;" target="_blank" rel="noopener">https://www.pinterest.com/pin/795518721656674891/&quot;</a><br>title:<br>“41 American Home Decor To Update Your Room”<br>description:</p>
<p>“Dizzy American Home Decor from 41 of the Brilliant American Home Decor collection is the most trending home decor this winter. This Brilliant American Home Decor look was carefully discovered by our home decoration and interior designers and defined as most wanted and expected this time of the year. This Cool American Home Decor will … Read more 41 American Home Decor To Update Your Room”</p>
<p>Name:<br>“Big Interior Design Blog”<br>fans_num:<br>9093<br>comments:</p>
<p>multi_quality_all</p>
<p>_id:<br>ObjectId(“5eafcdc4e1e9b6982ce7109c”)</p>
<p>uuid:<br>“fdce657d-26bc-44dc-b553-38708df8886a”</p>
<p>path:<br>“/data/filerun/data/PhotoBank/V2/Pinterest phase 2/Interior Design/Filtered_Unfiltered/Unfiltered Folder/Characteristic/Interior_design_Barn/299207968995030130.jpg”</p>
<p>“/data/filerun/data/PhotoBank/V2/Pinterest phase 2/Interior Design/Filtered_Unfiltered/Unfiltered Folder/Style/Interior_design_Zen/0804-1773d8d10b62d3e1166f5a78a3688221.jpg”<br>“/data/filerun/data/PhotoBank/V2/Pinterest phase 2/Interior Design/Filtered_Unfiltered/Unfiltered Folder/Style/Interior_design_Zen/0751-fd47df6c54b69c79f52c32b779380761.jpg”</p>
<p>关于数据：</p>
<ol>
<li>multi-quality 中 _id 和 uuid 是什么意思？ 对应网页中的什么部分，代码是如何写的<br>（个人感觉 id 和_id 是对应到一块的）</li>
</ol>
<p>12w 中有重复的图片吧（比如说 cf3f268fc488f2a9798c0a8d03370a94.jpg 这个图片在数据库中出现了两次？）</p>
<ol start="2">
<li>新版的code 是如何对应的（看代码）</li>
</ol>
<p>属于匹配进度：</p>
<p>先使用 path 的后缀名和原来的图片名称进行匹配，目前使用的是 multi_quality_all数据集中的 path 和 pin_text 中的 original_pics 进行匹配。前者需要提取 basename （有的filename 需要去掉前缀），后者需要提取basename</p>
<h2 id="可运行的方案"><a href="#可运行的方案" class="headerlink" title="可运行的方案"></a>可运行的方案</h2><ol>
<li>简单方案 </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 这个命令是 restart kibana:7.2.0  和  elasticsearch:7.2.0 </span><br><span class="line">docker restart a8d835f1916e 2c67e9a24aac</span><br></pre></td></tr></table></figure>

<p>然后在 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.1.34:5601&#x2F;app&#x2F;kibana#&#x2F;dev_tools&#x2F;console?_g&#x3D;()</span><br></pre></td></tr></table></figure>

<p>使用 Get 查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;img_text&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;&quot;column3&quot;: &quot;interior modern style&quot;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: [&quot;column1&quot;,&quot;column3&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的是图片list </p>
<ol start="2">
<li>进阶版本</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd  &#x2F;home&#x2F;jeng&#x2F;Projects&#x2F;es_search_engine</span><br><span class="line"># 然后 restart 之前的镜像</span><br><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure>

<p>访问： <a href="http://192.168.1.34:8005" target="_blank" rel="noopener">http://192.168.1.34:8005</a> 就有效果了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http:&#x2F;&#x2F;127.0.0.1:8005&#x2F; -d query&#x3D;&quot;python&quot;</span><br></pre></td></tr></table></figure>





























      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/24/optical_flow/" rel="next" title="Optical Flow">
                <i class="fa fa-chevron-left"></i> Optical Flow
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/06/front_end/" rel="prev" title="前端和Vue的笔记">
                前端和Vue的笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Jijeng Jia" />
            
              <p class="site-author-name" itemprop="name">Jijeng Jia</p>
              <p class="site-description motion-element" itemprop="description">Solving Problems by Coding</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">168</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">83</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jijeng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jia1509309698@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          <script type="text/javascript" src="//rf.revolvermaps.com/0/0/5.js?i=5kk0u0mm50w&amp;m=0&amp;c=54ff00&amp;cr1=ff0000" async="async"></script>


        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义和特点"><span class="nav-number">1.</span> <span class="nav-text">定义和特点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念和原理"><span class="nav-number">1.1.</span> <span class="nav-text">概念和原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#elastic-search-特点"><span class="nav-number">1.2.</span> <span class="nav-text">elastic search 特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#elasticsearch-的不足"><span class="nav-number">1.3.</span> <span class="nav-text">elasticsearch 的不足</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#学习笔记"><span class="nav-number">2.</span> <span class="nav-text">学习笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ES-中index-的理解"><span class="nav-number">2.1.</span> <span class="nav-text">ES 中index 的理解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献"><span class="nav-number">3.</span> <span class="nav-text">参考文献</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#教程方面"><span class="nav-number">3.1.</span> <span class="nav-text">教程方面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#code方面"><span class="nav-number">3.2.</span> <span class="nav-text">code方面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据整合"><span class="nav-number">4.</span> <span class="nav-text">数据整合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可运行的方案"><span class="nav-number">5.</span> <span class="nav-text">可运行的方案</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jijeng Jia</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
Total  <span id="busuanzi_value_site_pv"></span> views
You got  <span id="busuanzi_value_site_uv"></span> visitors
</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://https-jijeng-github-io.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2020/06/29/elastic_search/';
          this.page.identifier = '2020/06/29/elastic_search/';
          this.page.title = 'Elastic Search';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://https-jijeng-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  















  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('10');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
